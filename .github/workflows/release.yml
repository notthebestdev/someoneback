name: Release

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
    contents: write

jobs:
    check-lint:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout repository
              uses: actions/checkout@v5
              with:
                  fetch-depth: 0

            - name: Setup Node.js
              uses: actions/setup-node@v6
              with:
                  node-version: 'lts/*'
                  cache: 'npm'
                  cache-dependency-path: '**/package-lock.json'

            - name: Install dependencies
              run: npm ci --prefer-offline --no-audit --silent || npm install --no-audit --silent

            - name: Lint project
              run: npm run lint

    release:
        needs: check-lint
        runs-on: ubuntu-latest
        timeout-minutes: 120
        steps:
            - name: Checkout repository
              uses: actions/checkout@v5

            - name: Setup Node.js
              uses: actions/setup-node@v6
              with:
                  node-version: 'lts/*'
                  cache: 'npm'
                  cache-dependency-path: '**/package-lock.json'

            - name: Install dependencies
              run: npm ci --prefer-offline --no-audit --silent || npm install --no-audit --silent

            - name: Get hash based on entire project
              id: vars
              run: |
                  echo "HASH=$(git rev-parse --short=7 HEAD)" >> $GITHUB_ENV

            - name: Update version in package.json
              run: |
                  npm version prerelease --preid=${{ env.HASH }} --no-git-tag-version

            - name: Create Git tag
              run: |
                git config user.name "github-actions[bot]"
                git config user.email "github-actions[bot]@users.noreply.github.com"
                git tag ${{ env.HASH }}
                git push origin ${{ env.HASH }}
